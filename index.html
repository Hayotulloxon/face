<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <title>Yuz Chiroyliligi O'lchagich</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
  />
  <style>
    body {
      background: linear-gradient(120deg, #f9d423, #ff4e50);
      min-height: 100vh;
      color: #222;
    }
    .wow-card {
      background: #fff;
      border-radius: 2rem;
      box-shadow: 0 8px 40px 0 rgba(0,0,0,0.2);
      padding: 2rem;
      margin-top: 2rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .result-section {
      margin-top: 2rem;
    }
    .face-img {
      max-width: 250px;
      border-radius: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 20px 0 rgba(0,0,0,0.15);
    }
    .score-bar {
      height: 1.2rem;
      border-radius: 0.6rem;
      background: #f5f5f5;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    .score-fill {
      height: 100%;
      background: linear-gradient(90deg, #43cea2, #185a9d);
      transition: width 1s;
    }
    .wow-brand {
      font-family: 'Pacifico', cursive;
      color: #ff4e50;
      font-size: 2.4rem;
      margin-bottom: 1rem;
      text-shadow: 0 2px 12px #f9d42380;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="wow-card animate__animated animate__fadeInDown">
      <div class="wow-brand text-center">WOW Yuz Chiroyliligi O'lchagich üòç</div>
      <form id="faceForm" class="mb-4">
        <input type="file" id="faceInput" accept="image/*" class="form-control mb-3" required>
        <button type="submit" class="btn btn-warning btn-lg w-100">Yuzni Baholash</button>
      </form>
      <div id="loading" class="text-center text-info" style="display:none;">
        <div class="spinner-border"></div>
        <div>Yuz aniqlanmoqda...</div>
      </div>
      <div id="result" class="result-section"></div>
    </div>
  </div>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <script>
  // Yuz qismlarini baholash uchun oddiy algoritm (masalan: ko'zlar orasidagi masofa, burun uzunligi va h.k.)
  function rateFace(landmarks) {
    const points = landmarks.positions;
    // 1. Ko'zlar orasidagi masofa / yuz eni
    const leftEye = points[36];
    const rightEye = points[45];
    const eyeDist = Math.hypot(rightEye.x - leftEye.x, rightEye.y - leftEye.y);
    const faceWidth = Math.hypot(points[16].x - points[0].x, points[16].y - points[0].y);
    const eyeRatio = eyeDist / faceWidth;
    let eyeScore = Math.max(0, 100 - Math.abs(eyeRatio - 0.32)*500);

    // 2. Burun uzunligi / yuz balandligi
    const noseTop = points[27];
    const noseBottom = points[33];
    const chin = points[8];
    const faceHeight = Math.hypot(chin.x - points[27].x, chin.y - points[27].y);
    const noseLength = Math.hypot(noseBottom.x - noseTop.x, noseBottom.y - noseTop.y);
    const noseRatio = noseLength / faceHeight;
    let noseScore = Math.max(0, 100 - Math.abs(noseRatio - 0.33)*700);

    // 3. Og'iz eni / yuz eni
    const mouthLeft = points[48];
    const mouthRight = points[54];
    const mouthWidth = Math.hypot(mouthRight.x - mouthLeft.x, mouthRight.y - mouthLeft.y);
    const mouthRatio = mouthWidth / faceWidth;
    let mouthScore = Math.max(0, 100 - Math.abs(mouthRatio - 0.40)*400);

    // 4. Simmetriya (chap va o'ng yuz qismlari masofasi o'xshashligi)
    let symScore = 100 - Math.abs(points[0].y - points[16].y) * 2;
    symScore = Math.max(0, symScore);

    // Umumiy baho
    const overall = Math.round((eyeScore + noseScore + mouthScore + symScore) / 4);

    return {
      eyeScore: Math.round(eyeScore),
      noseScore: Math.round(noseScore),
      mouthScore: Math.round(mouthScore),
      symScore: Math.round(symScore),
      overall
    };
  }

  // Tez yuz aniqlash uchun ssdMobilenetv1 va landmark68TinyNet ishlatamiz
  async function loadModels() {
    await faceapi.nets.ssdMobilenetv1.loadFromUri('models');
    await faceapi.nets.faceLandmark68TinyNet.loadFromUri('models');
  }
  loadModels();

  document.getElementById('faceForm').onsubmit = async function(e) {
    e.preventDefault();
    document.getElementById('result').innerHTML = '';
    document.getElementById('loading').style.display = '';
    const file = document.getElementById('faceInput').files[0];
    if (!file) return;
    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = async () => {
      const canvas = document.createElement('canvas');
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);

      // Yuz aniqlash (ssdMobilenetv1 + landmark68TinyNet)
      const detections = await faceapi
        .detectSingleFace(canvas, new faceapi.SsdMobilenetv1Options())
        .withFaceLandmarks(true);

      document.getElementById('loading').style.display = 'none';

      if (!detections) {
        document.getElementById('result').innerHTML =
          `<div class="alert alert-danger animate__animated animate__bounceIn">
            <b>Rasmda yuz yo'q!</b><br>Yuz aniqlanmadi. Iltimos, aniq yuzli rasm yuklang.
          </div>`;
        return;
      }

      // Baholash
      const scores = rateFace(detections.landmarks);
      document.getElementById('result').innerHTML = `
        <div class="text-center">
          <img src="${img.src}" class="face-img animate__animated animate__fadeIn"/>
        </div>
        <div class="score-bar mb-2"><div class="score-fill" style="width: ${scores.eyeScore}%;"></div></div>
        <b>Ko'zlar nisbati:</b> <span>${scores.eyeScore}/100</span><br>
        <div class="score-bar mb-2"><div class="score-fill" style="width: ${scores.noseScore}%;"></div></div>
        <b>Burun uzunligi:</b> <span>${scores.noseScore}/100</span><br>
        <div class="score-bar mb-2"><div class="score-fill" style="width: ${scores.mouthScore}%;"></div></div>
        <b>Og'iz kengligi:</b> <span>${scores.mouthScore}/100</span><br>
        <div class="score-bar mb-2"><div class="score-fill" style="width: ${scores.symScore}%;"></div></div>
        <b>Simmetriya:</b> <span>${scores.symScore}/100</span><br>
        <hr>
        <div class="display-5 fw-bold text-center text-success animate__animated animate__pulse">
          Umumiy baho: <span>${scores.overall}/100</span>
        </div>
        <div class="text-center mt-2">
          <span style="font-size:2rem;">${
            scores.overall > 85 ? 'üòç' : (scores.overall > 60 ? 'üòä' : 'üôÇ')
          }</span>
        </div>
      `;
    };
  }
  </script>
</body>
</html>
